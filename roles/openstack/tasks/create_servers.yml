---
- name: create server instances
  os_server:
    name: "{{ item.name|default('%s%d'|format(OS_SERVER_PREFIX, index)) }}"
    flavor: "{{ item.flavor|default(OS_FLAVOR_NAME) }}"
    image: "{{ item.image|default(OS_IMAGE_NAME) }}"
    boot_from_volume: "{{ item.boot_from_volume|default('windows' in OS_IMAGE_NAME|lower) }}"
    volume_size: "{{ item.volume_size|default('windows' in OS_IMAGE_NAME|lower and 100 or 0) }}"
    terminate_volume: "{{ item.terminate_volume|default('yes') }}"
    key_name: "{{ item.keypair|default(OS_KEYPAIR_NAME) }}"
    network: "{{ OS_NETWORK_NAME }}"
    auto_floating_ip: "{{ item.auto_floating_ip|default(OS_AUTO_FLOATING_IP) }}"
    userdata: "{{lookup('template', item.userdata|default(OS_USERDATA_FILE))}}"
    meta:
      group: "{{ ENV_NAME }}"
      groups: "{{ item.groups|default(OS_META_GROUPS)|join(',') }}"
      cloud: openstack  #  will create hosts group meta-cloud_openstack
      index: "{{index|string}}"
    security_groups: "{{item.security_groups|default(OS_SECURITY_GROUPS)}}"
    wait: yes
  async: 180
  poll: 0
  loop: "{{OS_SERVERS}}"
  loop_control:
    index_var: index
  register: os_server_loop

- name: wait for instance creation to be complete
  async_status:
    jid: "{{item.ansible_job_id}}"
    mode: status
  until: os_server_jobs.finished
  retries: 100
  loop: "{{os_server_loop.results}}"
  register: os_server_jobs

- name: refresh in-memory openstack dynamic inventory
  meta: refresh_inventory

- name: refresh cached openstack dynamic inventory
  command: "{{item}} --refresh --list"
  with_items:
    -  "{{lookup('config', 'DEFAULT_HOST_LIST')}}"
