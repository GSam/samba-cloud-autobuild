{
    "variables": {
        "image": "{{env `PACKER_IMAGE`}}",
        "flavor": "{{env `PACKER_FLAVOR`}}",
        "net_id": "{{env `PACKER_NET_ID`}}",
        "password": "{{env `PACKER_PASSWORD`}}",
        "user_data_file": "{{env `PACKER_CLOUD_INIT_FILE`}}",
        "ms_downloads": "{{env `PACKER_MS_DOWNLOADS`}}"
    },
    "builders": [{
        "type": "openstack",
        "image_name": "windows-test-image-template",
        "source_image_name": "{{user `image`}}",
        "flavor": "{{user `flavor`}}",
        "security_groups": ["winrm-ok"],
        "floating_ip_pool": "public-net",
        "networks": ["{{user `net_id`}}"],
        "communicator": "winrm",
        "winrm_username": "Administrator",
        "winrm_password": "{{user `password`}}",
        "user_data_file": "{{user `cloud_init_file`}}"
    }],
    "provisioners": [{
        "type": "file",
        "source": "{{user `ms_downloads`}}/firefox.exe",
        "destination": "c:\\firefox.exe"
    },
    {
        "type": "file",
        "source": "{{user `ms_downloads`}}/winpcap-nmap.exe",
        "destination": "c:\\winpcap-nmap.exe"
    },
    {
        "type": "file",
        "source": "{{user `ms_downloads`}}/wireshark.exe",
        "destination": "c:\\wireshark.exe"
    },
    {
        "type": "powershell",
        "inline": ["c:\\firefox.exe -ms",
                  "c:\\winpcap-nmap.exe /S",
                  "c:\\wireshark.exe /S"]
    },
    {
        "type": "file",
        "source": "{{user `ms_downloads`}}/setupssh.exe",
        "destination": "c:\\setupssh.exe"
    },
    {
        "type": "powershell",
        "inline": ["c:\\setupssh.exe /password={{user `password`}} /privsep=1 /S"]
    },
    {
        "type": "powershell",
        "inline": ["Invoke-WebRequest -Uri 'https://raw.githubusercontent.com/Microsoft/WindowsProtocolTestSuites/staging/InstallPrerequisites/InstallPrerequisites.ps1'  -OutFile 'C:\\InstallPrerequisites.ps1'",
                  "Invoke-WebRequest -Uri 'https://raw.githubusercontent.com/Microsoft/WindowsProtocolTestSuites/staging/InstallPrerequisites/PrerequisitesConfig.xml'  -OutFile 'C:\\PrerequisitesConfig.xml'",
                  "Invoke-WebRequest -Uri 'https://github.com/Microsoft/WindowsProtocolTestSuites/archive/master.zip' -OutFile 'C:\\WindowsProtocolTestSuites.zip'",
                  "c:\\InstallPrerequisites.ps1 -Category 'Kerberos' -ConfigPath c:\\PrerequisitesConfig.xml"]
    },
    {
        "type": "file",
        "source": "{{user `ms_downloads`}}/ProtocolTestManager.msi",
        "destination": "c:\\ProtocolTestManager.msi"
    },
    {
        "type": "powershell",
        "inline": ["c:\\ProtocolTestManager.msi /q"]
    },
    {
        "type": "file",
        "source": "{{user `ms_downloads`}}/ADFamily-TestSuite-ServerEP.msi",
        "destination": "c:\\ADFamily-TestSuite-ServerEP.msi"
    },
    {
        "type": "file",
        "source": "{{user `ms_downloads`}}/Kerberos-TestSuite-ServerEP.msi",
        "destination": "c:\\Kerberos-TestSuite-ServerEP.msi"
    },
    {
        "type": "file",
        "source": "{{user `ms_downloads`}}/MS-AZOD-TestSuite-ODEP.msi",
        "destination": "c:\\MS-AZOD-TestSuite-ODEP.msi"
    },
    {
        "type": "windows-restart"
    }]
}
